module MCMario.GameDB.QueryCache
	( -- | A cache for information that could, in theory, be computed from a
	  -- 'GameDB', but which can be more cheaply incrementally updated as
	  -- 'GameRecord's are added.
	  QueryCache
	, fromGameDB
	, addGame
	, gdb
	, melee
	, edgesBetween
	, speedPref
	, components
	, playerComponentGames
	, listPlayers
	, Name
	, Speed(..)
	, PlayerSettings(..)
	, GameRecord(..)
	, GameDB
	, Component
	) where

import Data.List
import Data.Map (Map)
import Data.Monoid
import Data.MonoidMap (MMap)
import Data.Ord
import Data.Partition (Partition)
import MCMario.GameDB (Name, Component, Speed(..), PlayerSettings(..), GameRecord(..), GameDB)
import qualified Data.Map as M
import qualified Data.MonoidMap as MM
import qualified Data.Partition as P
import qualified MCMario.GameDB as GDB

data QueryCache = QueryCache
	{ gdb :: GameDB
	, playerStats :: MMap Name PlayerStats
	, meleeGames :: MMap Name [GameRecord]
	, melees :: Partition Name
	} deriving (Eq, Show)

fromGameDB :: GameDB -> QueryCache
fromGameDB gdb = QueryCache
	{ gdb = gdb
	, playerStats = foldMap statsFromGameRecord (GDB.listGames gdb)
	, meleeGames = MM.fromList (GDB.playersComponentGames gdb cs)
	, melees = P.unsafeFromSets cs
	}
	where
	cs = GDB.components gdb

addGame :: GameRecord -> QueryCache -> QueryCache
addGame g qc = QueryCache
	{ gdb = gdb'
	, playerStats = mappend (statsFromGameRecord g) (playerStats qc)
	, meleeGames = if sameMelee
	               then mappend (gamesFromGameRecord g) (meleeGames qc)
	               -- TODO: only recalculate when the melee changes
	               else MM.fromList (GDB.playersComponentGames gdb' cs)
	, melees = if sameMelee
	           then melees qc
	           else P.unsafeFromSets cs
	}
	where
	gdb' = GDB.addGame g (gdb qc)
	cs = GDB.components gdb'
	sameMelee = P.sameSubset (melees qc) (name (winner g)) (name (loser g))

gamesFromGameRecord :: GameRecord -> MMap Name [GameRecord]
gamesFromGameRecord g
	=  MM.singleton (name (loser  g)) [g]
	<> MM.singleton (name (winner g)) [g]

melee :: QueryCache -> Name -> Component
melee = P.subset . melees

components :: QueryCache -> [Component]
components = P.subsets . melees

edgesBetween :: QueryCache -> Component -> Component -> [GameRecord]
edgesBetween = GDB.edgesBetween . gdb

speedPref :: QueryCache -> Name -> Speed
speedPref qc n = fst . minimumBy (comparing fst) $ pairs where
	counts = speeds (playerStats qc MM.! n)
	pairs | counts == mempty = [(Medium, 1)]
	      | otherwise = [(s, counts MM.! s) | s <- [Low, Medium, High]]

playerComponentGames :: QueryCache -> Name -> [GameRecord]
playerComponentGames qc n = meleeGames qc MM.! n

listPlayers :: QueryCache -> [Name]
listPlayers = id
	. map fst
	. sortBy (comparing (negate . games . snd))
	. MM.toList
	. playerStats

data PlayerStats = PlayerStats
	{ games  :: Sum Int
	, speeds :: MMap Speed (Sum Int)
	, levels :: MMap Integer (Sum Integer)
	} deriving (Eq, Ord, Show)

instance Monoid PlayerStats where
	mempty = PlayerStats
		{ games  = mempty
		, speeds = mempty
		, levels = mempty
		}
	mappend s1 s2 = PlayerStats
		{ games  = games  s1 `mappend` games  s2
		, speeds = speeds s1 `mappend` speeds s2
		, levels = levels s1 `mappend` levels s2
		}

statsFromGameRecord :: GameRecord -> MMap Name PlayerStats
statsFromGameRecord g
	=  statsFromPlayerSettings (winner g)
	<> statsFromPlayerSettings (loser  g)

statsFromPlayerSettings :: PlayerSettings -> MMap Name PlayerStats
statsFromPlayerSettings ps = MM.singleton (name ps) PlayerStats
	{ games  = 1
	, speeds = MM.singleton (speed ps) 1
	, levels = levelsMap MM.! level ps
	}

-- | We want to suggest levels near where you've played before, but don't want
-- to outright reject a level just because you've never played on it before. So
-- instead of counting how many times you've played each level, we smooth
-- things out a bit. Specifically, if you play level @m@, then we add weight to
-- level @n@ proportional to the probability of seeing @n@ heads when flipping
-- 20 coins that come up heads @(m+1)/22@ of the time. This puts the most
-- weight on level @m@, and less weight on levels far away from @m@, but
-- nonzero weight on every level.
--
-- 'levelsMap' is a precomputed table of these probabilities, scaled by the
-- smallest positive number that makes everything an integer. The outer 'MMap'
-- is for @m@ in the above discussion, and the inner 'MMap' is for @n@.
levelsMap :: MMap Integer (MMap Integer (Sum Integer))
levelsMap = fromElemList . map fromElemList $ weights where
	fromElemList = MM.fromDistinctAscList . zip [0..]
	weights = [[278218429446951548637196401,264969932806620522511615620,119867350555375950660016590,34247814444393128760004740,6931105304222418915715245,1056168427310082882394704,125734336584533676475560,11974698722336540616720,926613591609375166770,58832608991071439160,3081708090008503956,133407276623744760,4764545593705170,139620383698320,3324294849960,63319901904,942260445,10557540,83790,420,1],[104857600000000000000000000,209715200000000000000000000,199229440000000000000000000,119537664000000000000000000,50803507200000000000000000,16257122304000000000000000,4064280576000000000000000,812856115200000000000000,132089118720000000000000,17611882496000000000000,1937307074560000000000,176118824960000000000,13208911872000000000,812856115200000000,40642805760000000,1625712230400000,50803507200000,1195376640000,19922944000,209715200,1048576],[37589973457545958193355601,118705179339618815347438740,178057769009428223021158110,168686307482616211283202420,113197390547545089150570045,57194471013496466097130128,22576764873748605038340840,7129504696973243696318160,1829280810407608579976370,385111749559496543152920,66887830186649399600244,9601123950236755923480,1136975204633300043570,110475323527122271440,8721736067930705640,550846488500886672,27179925419451645,1009780510939380,26573171340510,441659357460,3486784401],[12748236216396078174437376,56658827628427014108610560,119613080548901474229288960,159484107398535298972385280,150623879209727782362808320,107110314104695311902441472,59505730058164062168023040,26446991136961805408010240,9550302355013985286225920,2829719216300440084807680,691709141762329798508544,139739220558046423941120,23289870093007737323520,3184939499898493992960,353882166655388221440,31456192591590064128,2184457818860421120,114220016672440320,4230370987868160,98956046499840,1099511627776],[4064231406647572522401601,23907243568515132484715300,66799651147321693707292750,117881737318802988895222500,147352171648503736119028125,138684396845650575170850000,101973821210037187625625000,59984600711786580956250000,28669110634309762957031250,11242788484043044296875000,3637372744837455507812500,972559557443169921875000,214535196494816894531250,38829899818066406250000,5710279385009765625000,671797574707031250000,61746100616455078125,4273086547851562500,209465026855468750,6484985351562500,95367431640625],[1208925819614629174706176,9066943647109718810296320,32300986742828373261680640,72677220171363839838781440,115829319648111119743057920,138995183577733343691669504,130307984604125009710940160,97730988453093757283205120,59554821088604008344453120,29777410544302004172226560,12283181849524576721043456,4187448357792469336719360,1177719850629132000952320,271781503991338154065920,50959031998375903887360,7643854799756385583104,895764234346451435520,79038020677628067840,4939876292351754240,194995116803358720,3656158440062976],[332525673007965087890625,3103572948074340820312500,13759173403129577636718750,38525685528762817382812500,76409276298712921142578125,114104519272744628906250000,133121939151535400390625000,124247143208099707031250000,94220750266142277832031250,58626244610044083984375000,30094805566489296445312500,12767493270631822734375000,4468622644721137957031250,1283296759509660131250000,299435910552254030625000,55894703303087419050000,8151310898366915278125,895045902565778932500,69614681310671694750,3419668555611942900,79792266297612001],[83668255425284801560576,956208633431826303549440,5190846867201342790696960,17797189258976032425246720,43221745343227507318456320,79034048627616013382320128,112905783753737161974743040,129035181432842470828277760,119818382759068008626257920,91290196387861339905720320,57382409158084270797881344,29809043718485335479418880,12775304450779429491179520,4492414751922436744151040,1283547071977839069757440,293382187880648930230272,52389676407258737541120,7043990105177645383680,670856200493109084160,40352252661239644160,1152921504606846976],[19004963774880799438801,263145652267580299921860,1730688712990624280255310,7189014653961054702598980,21152293116462334028800845,46860464750316555386881872,81104650529394038169603240,112298746886853283619450640,126336090247709944071881970,116617929459424563758660280,88809038588331013939287444,55893800510138400381369720,29021781034110323274941970,12364309079620966128969360,4279953142945719044643240,1185217793431122196978128,256417311078848552230845,41769335741350895386020,4819538739386641775310,351221446594977943140,12157665459056928801],[3833759992447475122176,63895999874124585369600,505843332336819634176000,2529216661684098170880000,8957642343464514355200000,23887046249238704947200000,49764679685913968640000000,82941132809856614400000000,112316117346680832000000000,124795685940756480000000000,114396045445693440000000000,86663670792192000000000000,54164794245120000000000000,27776817561600000000000000,11573673984000000000000000,3857891328000000000000000,1004659200000000000000000,196992000000000000000000,27360000000000000000000,2400000000000000000000,100000000000000000000],[672749994932560009201,13454999898651200184020,127822499037186401748190,766934994223118410489140,3259473725448253244578845,10430315921434410382652304,26075789803586025956630760,52151579607172051913261520,84746316861654584359049970,112995089148872779145399960,124294598063760057059939956,112995089148872779145399960,84746316861654584359049970,52151579607172051913261520,26075789803586025956630760,10430315921434410382652304,3259473725448253244578845,766934994223118410489140,127822499037186401748190,13454999898651200184020,672749994932560009201],[100000000000000000000,2400000000000000000000,27360000000000000000000,196992000000000000000000,1004659200000000000000000,3857891328000000000000000,11573673984000000000000000,27776817561600000000000000,54164794245120000000000000,86663670792192000000000000,114396045445693440000000000,124795685940756480000000000,112316117346680832000000000,82941132809856614400000000,49764679685913968640000000,23887046249238704947200000,8957642343464514355200000,2529216661684098170880000,505843332336819634176000,63895999874124585369600,3833759992447475122176],[12157665459056928801,351221446594977943140,4819538739386641775310,41769335741350895386020,256417311078848552230845,1185217793431122196978128,4279953142945719044643240,12364309079620966128969360,29021781034110323274941970,55893800510138400381369720,88809038588331013939287444,116617929459424563758660280,126336090247709944071881970,112298746886853283619450640,81104650529394038169603240,46860464750316555386881872,21152293116462334028800845,7189014653961054702598980,1730688712990624280255310,263145652267580299921860,19004963774880799438801],[1152921504606846976,40352252661239644160,670856200493109084160,7043990105177645383680,52389676407258737541120,293382187880648930230272,1283547071977839069757440,4492414751922436744151040,12775304450779429491179520,29809043718485335479418880,57382409158084270797881344,91290196387861339905720320,119818382759068008626257920,129035181432842470828277760,112905783753737161974743040,79034048627616013382320128,43221745343227507318456320,17797189258976032425246720,5190846867201342790696960,956208633431826303549440,83668255425284801560576],[79792266297612001,3419668555611942900,69614681310671694750,895045902565778932500,8151310898366915278125,55894703303087419050000,299435910552254030625000,1283296759509660131250000,4468622644721137957031250,12767493270631822734375000,30094805566489296445312500,58626244610044083984375000,94220750266142277832031250,124247143208099707031250000,133121939151535400390625000,114104519272744628906250000,76409276298712921142578125,38525685528762817382812500,13759173403129577636718750,3103572948074340820312500,332525673007965087890625],[3656158440062976,194995116803358720,4939876292351754240,79038020677628067840,895764234346451435520,7643854799756385583104,50959031998375903887360,271781503991338154065920,1177719850629132000952320,4187448357792469336719360,12283181849524576721043456,29777410544302004172226560,59554821088604008344453120,97730988453093757283205120,130307984604125009710940160,138995183577733343691669504,115829319648111119743057920,72677220171363839838781440,32300986742828373261680640,9066943647109718810296320,1208925819614629174706176],[95367431640625,6484985351562500,209465026855468750,4273086547851562500,61746100616455078125,671797574707031250000,5710279385009765625000,38829899818066406250000,214535196494816894531250,972559557443169921875000,3637372744837455507812500,11242788484043044296875000,28669110634309762957031250,59984600711786580956250000,101973821210037187625625000,138684396845650575170850000,147352171648503736119028125,117881737318802988895222500,66799651147321693707292750,23907243568515132484715300,4064231406647572522401601],[1099511627776,98956046499840,4230370987868160,114220016672440320,2184457818860421120,31456192591590064128,353882166655388221440,3184939499898493992960,23289870093007737323520,139739220558046423941120,691709141762329798508544,2829719216300440084807680,9550302355013985286225920,26446991136961805408010240,59505730058164062168023040,107110314104695311902441472,150623879209727782362808320,159484107398535298972385280,119613080548901474229288960,56658827628427014108610560,12748236216396078174437376],[3486784401,441659357460,26573171340510,1009780510939380,27179925419451645,550846488500886672,8721736067930705640,110475323527122271440,1136975204633300043570,9601123950236755923480,66887830186649399600244,385111749559496543152920,1829280810407608579976370,7129504696973243696318160,22576764873748605038340840,57194471013496466097130128,113197390547545089150570045,168686307482616211283202420,178057769009428223021158110,118705179339618815347438740,37589973457545958193355601],[1048576,209715200,19922944000,1195376640000,50803507200000,1625712230400000,40642805760000000,812856115200000000,13208911872000000000,176118824960000000000,1937307074560000000000,17611882496000000000000,132089118720000000000000,812856115200000000000000,4064280576000000000000000,16257122304000000000000000,50803507200000000000000000,119537664000000000000000000,199229440000000000000000000,209715200000000000000000000,104857600000000000000000000],[1,420,83790,10557540,942260445,63319901904,3324294849960,139620383698320,4764545593705170,133407276623744760,3081708090008503956,58832608991071439160,926613591609375166770,11974698722336540616720,125734336584533676475560,1056168427310082882394704,6931105304222418915715245,34247814444393128760004740,119867350555375950660016590,264969932806620522511615620,278218429446951548637196401]]
